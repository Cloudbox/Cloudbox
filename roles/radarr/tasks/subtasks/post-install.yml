#########################################################################
# Title:         Cloudbox: Radarr | Post-Install Tasks                  #
# Author(s):     desimaniac                                             #
# URL:           https://github.com/cloudbox/cloudbox                   #
# --                                                                    #
#         Part of the Cloudbox project: https://cloudbox.works          #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
# Update ports in preferences
- name: Post-Install | Check if '{{ radarr_paths_config_location | basename }}' exists
  stat:
    path: "{{ radarr_paths_config_location }}"
  register: radarr_paths_config_location_stat

- name: Post-Install | Update '{{ radarr_paths_config_location | basename }}'
  block:

  - name: Post-Install | Get host port that's mapped to docker port '7878'
    shell:
      docker port {{ radarr_docker_container }} 7878 | sed 's/[0-9.]*://'
    register: radarr_docker_port_7878
    changed_when: no

  - name: Post-Install | Set 'radarr_docker_port_7878' variable
    set_fact:
      radarr_docker_port_7878: >-
        {{ radarr_docker_port_7878.stdout | trim
            if radarr_docker_port_7878.stdout | trim | length > 0
            else '7878' }}

  - name: Post-Install | Update 'Port' in '{{ radarr_paths_config_location | basename }}'
    xml:
      path: "{{ radarr_paths_config_location }}"
      xpath: /Config/Port
      value: "{{ radarr_docker_port_7878 }}"
      state: present
    become: yes
    become_user: "{{ user.name }}"
    ignore_errors: yes

  when: radarr_paths_config_location_stat.stat.exists
