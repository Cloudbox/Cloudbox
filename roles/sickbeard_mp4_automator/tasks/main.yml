#########################################################################
# Title:         Cloudbox: Sickbeard MP4 Automator                      #
# Author(s):     desimaniac, andrewkhunn                                #
# URL:           https://github.com/cloudbox/cloudbox                   #
# --                                                                    #
#         Part of the Cloudbox project: https://cloudbox.rocks          #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
- name: "Create 'sickbeard_mp4_automator' directory"
  file: "path={{ item }} state=directory owner={{ user.name }} group={{ user.name }} mode=0775 recurse=yes"
  with_items:
    - "/opt/scripts/sickbeard_mp4_automator"

- name: "Clone 'sickbeard_mp4_automator' repo"
  git:
    repo: "https://github.com/mdhiggins/sickbeard_mp4_automator.git"
    dest: "/opt/scripts/sickbeard_mp4_automator"
    clone: yes
    version: HEAD
    force: yes
  become: yes
  become_user: "{{ user.name }}"

- name: "Wait for 'autoProcess.ini.sample' file"
  wait_for:
    path: "/opt/scripts/sickbeard_mp4_automator/setup/autoProcess.ini.sample"
    state: present

- name: "Check if 'autoProcess.ini' file exists"
  stat:
    path: "/opt/scripts/sickbeard_mp4_automator/autoProcess.ini"
  register: autoprocess_ini

- name: "'autoProcess.ini' Task"
  import_tasks: "autoprocess_ini.yml"
  when: not autoprocess_ini.stat.exists

- name: "Check if 'plex_autoscan.py' exists"
  stat:
    path: "/opt/scripts/sickbeard_mp4_automator/post_process/plex_autoscan.py"
  register: plex_autoscan_py

- name: "'plex_autoscan.py' Task"
  import_tasks: "plex_autoscan_py.yml"
  when: not plex_autoscan_py.stat.exists

- name: Create 'sma_update_container' variable
  set_fact:
    sma_update_container: "{{ ('sma' in ansible_run_tags
                                  or 'sickbeard_mp4_automator' in ansible_run_tags) }}"

- name: "Update Docker Containers Task"
  include_tasks: "update_docker_containers.yml"
  loop:
    - "sonarr"
    - "radarr"
    - "nzbget"
  loop_control:
    loop_var: app
  when: sma_update_container
