#########################################################################
# Title:         Cloudbox: iperf3 Role                                  #
# Author(s):     desimaniac                                             #
# URL:           https://github.com/cloudbox/cloudbox                   #
# --                                                                    #
#         Part of the Cloudbox project: https://cloudbox.works          #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
- name: Make sure iperf3 package is not installed
  apt: "name=iperf3 state=absent"

- name: Clone iperf3 repo
  git:
    repo: "{{ iperf3_git_repo_url }}"
    dest: "{{ iperf3_git_repo_dest }}"
    clone: yes
    version: HEAD
    force: yes
  register: iperf_clone_status

- name: Tasks to do with git clone is a success
  block:

  - name: Build and install iperf3
    shell: "{{ iperf3_binary_build_command }}"

  - name: Get iperf3 binary version
    shell: "{{ iperf3_binary_version_lookup_command }}"
    register: iperf3_binary_version

  - name: Display iperf3 binary version
    debug:
      msg: "iperf3 {{ iperf3_binary_version.stdout }} installed."

  when: iperf_clone_status is success