#########################################################################
# Title:         Cloudbox: Plex Plugins / WebTools | Post-Install       #
# Author(s):     desimaniac                                             #
# URL:           https://github.com/cloudbox/cloudbox                   #
# --                                                                    #
#         Part of the Cloudbox project: https://cloudbox.works          #
#########################################################################
#                   GNU General Public License v3.0                     #
#########################################################################
---
# Update WebTools ports in Preferences
- name: Post-Install | Install lxml pip module
  raw: pip install lxml

- name: Post-Install | Gather list of running Docker containers
  shell: "docker ps --format '{{ '{{' }} .Names{{ '}}' }}' | xargs echo -n"
  register: docker_running_containers_list
  changed_when: no

- name: Post-Install | Set 'docker_running_containers_list' variable
  set_fact:
    docker_running_containers_list: "{{ (docker_running_containers_list.stdout).split() }}"

- name: Post-Install | Start {{ plex_name | title }} container
  docker_container:
    name: "{{ plex_docker_container }}"
    state: "started"
  when: (plex_docker_container not in docker_running_containers_list)

- name: Post-Install | Wait for 5 seconds before continuing"
  wait_for:
    timeout: 5
  when: (plex_docker_container not in docker_running_containers_list)

- name: Post-Install | Get host port that's mapped to {{ plex_name | title }} docker http port '33400'
  shell:
    docker port {{ plex_docker_container }} 33400 | sed 's/[0-9.]*://'
  register: plex_docker_port_33400
  changed_when: no

- name: Post-Install | Set 'plex_docker_port_33400' variable
  set_fact:
    plex_docker_port_33400: "{{ plex_docker_port_33400.stdout | trim }}"

- name: Post-Install | Get host port that's mapped to {{ plex_name | title }} docker https port '33443'
  shell:
    docker port {{ plex_docker_container }} 33443 | sed 's/[0-9.]*://'
  register: plex_docker_port_33443
  changed_when: no

- name: Post-Install | Set 'plex_docker_port_33443' variable
  set_fact:
    plex_docker_port_33443: "{{ plex_docker_port_33443.stdout | trim }}"

- name: Post-Install | Wait for '{{ plex_plugin_webtools_paths_preferences_location | basename }}' to be created
  wait_for:
    path: "{{ plex_plugin_webtools_paths_preferences_location }}"
    state: present

- name: Post-Install | Update 'WEB_Port_http' in '{{ plex_plugin_webtools_paths_preferences_location | basename }}'
  xml:
    path: "{{ plex_plugin_webtools_paths_preferences_location }}"
    xpath: /PluginPreferences/WEB_Port_http
    value: "{{ plex_docker_port_33400 }}"
    state: present
  become: yes
  become_user: "{{ user.name }}"

- name: Post-Install | Update 'WEB_Port_https' in '{{ plex_plugin_webtools_paths_preferences_location | basename }}'
  xml:
    path: "{{ plex_plugin_webtools_paths_preferences_location }}"
    xpath: /PluginPreferences/WEB_Port_https
    value: "{{ plex_docker_port_33443 }}"
    state: present
  become: yes
  become_user: "{{ user.name }}"

- name: "Stop {{ plex_name | title }} container"
  docker_container:
    name: "{{ plex_docker_container }}"
    state: "stopped"
  when:
    - ('plex-plugin-webtools' in ansible_run_tags) or ('plex-plugin-webtools-reinstall' in ansible_run_tags)
    - (plex_docker_container not in docker_running_containers_list)
